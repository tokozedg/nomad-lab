### Lesson 05: Environment Variables & Basic Templating

Building on our previous lessons, we'll now explore how to make tasks more configurable using environment variables and Nomad's built-in templating feature. This allows you to generate configuration files dynamically at runtime and pass parameters to your applications. We'll also cover how these templated files can be mounted into Docker containers.

**Key Concepts:**

*   `task.env {}`:
    *   This block within a `task` stanza allows you to define environment variables that will be directly available to your task's process.
    *   Syntax: `env { VAR_NAME = "value" ANOTHER_VAR = "another_value" }`.
    *   These variables are accessible within your application (e.g., via `os.Getenv` in Go, `process.env` in Node.js, or simply `$VAR_NAME` in shell scripts) and also within Nomad's `template` stanza.

*   `template {}` stanza:
    *   Used within a `task` to render dynamic configuration files before the task starts.
    *   `data`: A string containing the template content. It uses Go's `text/template` syntax. A common function is `{{ env "VAR_NAME" }}` to embed environment variables (either from `task.env` or Nomad's built-in ones). You can also use functions like `{{ timeNow }}`.
    *   `destination`: A path relative to the task's working directory root (`alloc/<alloc_id>/<task_name>/`) where the rendered file will be written.
        *   `secrets/filename.txt`: Writes the file to the task's private secrets directory. This is the recommended location for sensitive data generated by templates.
        *   `local/filename.txt`: Writes the file to the task's local data directory.
    *   `change_mode` & `change_signal`: Control behavior when the template's rendered output changes (e.g., due to an updated environment variable if the job is re-evaluated). `"signal"` with `SIGHUP` is common for services to reload their configuration without a full restart.

*   **Task Working Directory and Key Environment Variables:**
    Nomad provides several environment variables to tasks that help locate important directories within the allocation's filesystem structure. Always use these variables to construct paths rather than hardcoding them.
    *   `NOMAD_ALLOC_DIR`: Path to the root of the allocation directory (e.g., `/opt/nomad/data/alloc/<alloc_id>/`). This directory is shared by all tasks in the same allocation.
    *   `NOMAD_TASK_DIR`: Path to the task's private local data directory (e.g., `NOMAD_ALLOC_DIR/<task_name>/local/` or `/opt/nomad/data/alloc/<alloc_id>/<task_name>/local/`).
    *   `NOMAD_SECRETS_DIR`: Path to the task's private secrets directory (e.g., `NOMAD_ALLOC_DIR/<task_name>/secrets/` or `/opt/nomad/data/alloc/<alloc_id>/<task_name>/secrets/`). Files in this directory (and the directory itself) have special protections: their contents cannot be read using `nomad alloc fs`. This is ideal for sensitive data like API keys or passwords generated by templates.

*   `task.config.mounts` (for Docker driver):
    *   Allows you to make files or directories from the host Nomad client (or from within the allocation's directory structure) available inside a Docker container.
    *   `type = "bind"`: Standard bind mount.
    *   `source`: The path on the host or within the allocation. If relative (e.g., `"secrets/app.conf"` or `"local/data.txt"`), it's resolved relative to the task's working directory root (`alloc/<alloc_id>/<task_name>/`). This allows you to easily mount files created by the `template` stanza.
    *   `target`: The absolute path inside the container where the `source` will be mounted.
    *   `readonly = true` (optional): Mounts the source as read-only within the container, which is good practice for configuration files.

## How to Use:

1.  **Save the HCL:**
    Ensure the HCL content for this lesson is saved as `05-env-templating.hcl`.

2.  **Run the job**:
    ```bash
    nomad job run 05-env-templating.hcl
    ```

3.  **Check job status**:
    ```bash
    nomad job status env-templating-example
    ```
    Wait for the allocation to be in the `running` state. Note the Allocation ID.


4.  **Interact with `nomad alloc fs` (from the host's perspective)**:
    Replace `<ALLOC_ID>` and `<task_name>` (which is `app-task` in this example).
    *   Attempt to view the templated secrets file directly using `nomad alloc fs`:
        ```bash
        nomad alloc fs <ALLOC_ID> app-task/secrets/app.ini
        ```
    *   Try to list the secrets directory:
        ```bash
        nomad alloc fs <ALLOC_ID> app-task/secrets/
        ```
        You might see the filename `app.ini` listed, but its content remains protected as shown above.
    *   List the task's local directory (will likely be empty for this example):
        ```bash
        nomad alloc fs <ALLOC_ID> app-task/local/app.conf
        ```

7.  **Stop the job**:
    ```bash
    nomad job stop -purge env-templating-example
    ```
